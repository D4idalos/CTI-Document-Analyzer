!function(w){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[];const HEEEET_KEYS={gclidInput:"gclid",msclkidInput:"msclkid",linkedinidInput:"li_fat_id",facebookidInput:"fbc_id",referrerInput:"utm_referrer",campaignNameInput:"utm_campaign",campaignSourceInput:"utm_source",campaignMediumInput:"utm_medium",campaignKeywordInput:"utm_keyword",campaignAdGroupInput:"utm_adgroup",onlineChannelInput:"channel",landingUrlInput:"landing_url",datetimeInput:"datetime"},HEEET_INCREMENTAL_KEYS={seoIncrementalInput:"channel_incremental.SEO",directIncrementalInput:"channel_incremental.Direct",otherIncrementalInput:"channel_incremental.Other",googleIncrementalInput:"channel_incremental.SEA.google",linkedinIncrementalInput:"channel_incremental.SEA.linkedin",facebookIncrementalInput:"channel_incremental.SEA.facebook",bingIncrementalInput:"channel_incremental.SEA.bing"},_MS_PER_DAY=6e4;var debug,isLocalStorageAvailable=function(){try{return window.localStorage,!0}catch(e){return!1}},dateDiffInMinutes=function(a,b){const utc1=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds()),utc2=Date.UTC(b.getFullYear(),b.getMonth(),b.getDate(),b.getUTCHours(),b.getUTCMinutes(),b.getUTCSeconds());return debugEnabled&&(console.log("---"),console.log("date diff : "),console.log(Math.floor((utc2-utc1)/6e4)),console.log("---")),Math.floor((utc2-utc1)/6e4)},debugEnabled=function(){const url=new URL(window.location.href);return url.searchParams.get("debug")}();w.onload=function(){const iframes=document.querySelectorAll(".subdomain-iframe");iframes&&iframes.forEach(iframe=>{const wind=iframe.contentWindow,data={heeet:localStorage.getItem("heeet")};debugEnabled&&(console.log("---"),console.log("posted to subdomain"),console.log(iframe),console.log(data),console.log("---")),wind.postMessage(data,"*")})},w.onmessage=function(e){e.data&&e.data.heeet&&(debugEnabled&&(console.log("---"),console.log("main domain > sub domain"),console.log(e.data.heeet),console.log("---")),heeetLocalStorage.saveAll(e.data.heeet))};var sendDataToDashboard=function(parameters,formLookup,heeetLocalstorage,cid){const mappingTableFields={gclid:"UtmGclid",msclkid:"UtmMsclkid",li_fat_id:"LiFatId",fbc_id:"UtmFbcId",utm_referrer:"Referrer",utm_campaign:"UtmCampaign",utm_source:"UtmSource",utm_medium:"UtmMedium",utm_keyword:"UtmKeyword",utm_term:"UtmKeyword",utm_adgroup:"UtmAdgroup",channel:"Channel",landing_url:"LandingUrl",datetime:"Datetime"},params={},fcData=heeetLocalstorage.get("first_visit"),lcData=heeetLocalstorage.get("last_visit"),increData=heeetLocalstorage.get("channel_incremental");for(const key in mappingTableFields)params["first"+mappingTableFields[key]]||(params["first"+mappingTableFields[key]]=fcData[key]);for(const key in mappingTableFields)params["last"+mappingTableFields[key]]||(params["last"+mappingTableFields[key]]=lcData[key]);params.firstCid=cid,params.lastCid=cid,params.seoIncremental=increData.SEO,params.directIncremental=increData.Direct,params.otherIncremental=increData.Other,params.googleIncremental=increData.SEA.google,params.linkedinIncremental=increData.SEA.linkedin,params.facebookIncremental=increData.SEA.facebook,params.bingIncremental=increData.SEA.bing,params.id=heeetLocalstorage.get("customId"),formLookup.forms.forEach(form=>{form.addEventListener("submit",(function(evt){fetch(`https://api.heeet.io/api/hit?publishableKey=${parameters.publishableKey}`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(params)}).then(response=>console.log(response))}))})},getReferrerChannel=function(){var referrer;return document.referrer&&document.referrer.search(window.location.host)<0&&(referrer=document.referrer),referrer&&(new RegExp(["google"].join("|")).test(referrer)?referrer="google":new RegExp(["linkedin"].join("|")).test(referrer)?referrer="linkedin":new RegExp(["bing"].join("|")).test(referrer)?referrer="bing":new RegExp(["facebook"].join("|")).test(referrer)&&(referrer="facebook")),referrer},getSEAChannel=function(){var sea_channel;const url=new URL(window.location.href),utmSource=url.searchParams.get("utm_source");var isFacebookAds=!1;return utmSource&&(utmSource.includes("facebook")||utmSource.includes("fbads"))&&(isFacebookAds=!0),url.searchParams.get("gclid")?sea_channel="google":url.searchParams.get("msclkid")?sea_channel="bing":url.searchParams.get("li_fat_id")?sea_channel="linkedin":(isFacebookAds||url.searchParams.get("fbc_id")||url.searchParams.get("fbcid"))&&(sea_channel="facebook"),sea_channel},getChannel=function(){var channel;const url=new URL(window.location.href),utmSource=url.searchParams.get("utm_source"),utmMedium=url.searchParams.get("utm_medium");var isFacebookAds=!1,referrer=null;return utmSource&&(utmSource.includes("facebook")||utmSource.includes("fbads"))&&(isFacebookAds=!0),document.referrer&&document.referrer.search(window.location.host)<0&&(referrer=document.referrer),url.searchParams.get("gclid")||url.searchParams.get("msclkid")?channel="SEA":url.searchParams.get("li_fat_id")||isFacebookAds||url.searchParams.get("fbc_id")||url.searchParams.get("fbcid")?channel="SEA":referrer?"affiliates"===utmMedium?channel="Affiliate":referrer&&(channel=new RegExp(["google","ecosia","qwant","bing"].join("|")).test(referrer)?"SEO":"Other"):channel="Direct",channel},computeInteractionDetails=function(data,visitData,incrementalData){var type,subType,name,channels={facebook:"Facebook",google:"Google",linkedin:"Linkedin",bing:"Bing"},keywords,found;if("SEA"===visitData.channel&&visitData.utm_campaign){name=visitData.utm_campaign,visitData.gclid||visitData.msclkid?type="SEA":visitData.fbc_id||visitData.li_fat_id?type="Social Ads":visitData.fbc_id&&!visitData.li_fat_id||!["facebook","linkedin"].includes(visitData.utm_referrer)||(type="Social Organic");var seaChannel=getSEAChannel();seaChannel&&(subType=channels[seaChannel])}else if("Direct"===visitData.channel)type="Direct",subType="Direct",name="Direct",visitData.utm_campaign&&(type="Other",type=visitData.utm_campaign);else if("SEO"===visitData.channel){var refChannel;type="SEO",name="SEO",(refChannel=getReferrerChannel())&&(subType=channels[refChannel])}else if("Other"===visitData.channel){var refChannel;type="Other",name=visitData.utm_campaign?visitData.utm_campaign:type,(refChannel=getReferrerChannel())&&(subType=channels[refChannel])}if(visitData.utm_keyword&&(keywords=visitData.utm_keyword),data.find(d=>d.name===name&&d.type===type&&d.subType===subType)){var index=data.findIndex(d=>d.type===type);data[index].interactions=data[index].interactions+1,data[index].isoDate=(new Date).toISOString(),data[index].intermediary=!0,data[index].keywords=keywords;for(let i=0;i<data.length;i++)data[i].last=!1;data[index].last=!0}else{var itm={last:!0,intermediary:!0,type:type,subType:subType,name:name,keywords:keywords,isoDate:(new Date).toISOString(),interactions:1};data.length||(itm.first=!0),data.push(itm)}return data.sort((function(a,b){return new Date(a.isoDate)-new Date(b.isoDate)})),data},computeIncremental=function(channel){var channelIncrem={SEO:0,Direct:0,Other:0,SEA:{linkedin:0,google:0,facebook:0,bing:0}};return"SEA"==channel?channelIncrem.SEA[getSEAChannel()]=1:channelIncrem[channel]=1,channelIncrem},GaExtractor=function(ga,ga4MeasurementId){try{this.ga=ga,this.ga4MeasurementId=ga4MeasurementId}catch(e){}debugEnabled&&(console.log("ga : "),console.log(this.ga))};GaExtractor.prototype.getCid=async function(){const _this=this;return new Promise((function(resolve,reject){gtag("get",_this.ga4MeasurementId,"client_id",client_id=>{resolve(client_id)})}))};var FormLookup=function(formName,formCssSelector){var forms=[];if(formName)Array.isArray(formName)?formName.forEach((function(element){forms.push(document.querySelector('form[name="'+element+'"]'))})):forms.push(document.querySelector('form[name="'+formName+'"]'));else if(formCssSelector)if(Array.isArray(formCssSelector))formCssSelector.forEach((function(cssSelector){const matchedForms=document.querySelectorAll(cssSelector);matchedForms.forEach(form=>{forms.push(form)})}));else{const matchedForms=document.querySelectorAll(formCssSelector);matchedForms.forEach(form=>{forms.push(form)})}else console.log("no form selector");forms=forms.filter((function(el){return null!=el})),debugEnabled&&(console.log("---"),console.log("forms : "),console.log(forms),console.log("---")),this.forms=forms};FormLookup.prototype.hasField=function(classOrName,value){return"name"===classOrName?this.form.querySelector('input[name="'+value+'"]'):this.form.querySelector(value)},FormLookup.prototype.setField=function(field,value){if(value||0==value){var classOrName=field.classOrName,val=field.value,input=this.hasField(classOrName,val);input||(input=this.createField(classOrName,val),this.form.appendChild(input)),debugEnabled&&(console.log("---"),console.log(`field ${classOrName}: `+val),console.log("value : "+value),console.log("---")),input.setAttribute("value",value)}},FormLookup.prototype.createField=function(classOrName,value){var input=document.createElement("input");return input.setAttribute("type","hidden"),input.setAttribute("name",value),input.setAttribute("class",value),input};var UrlDataCollector=function(){this.mappingKey={utm_term:"utm_keyword",fbclid:"fbc_id"},this.attributes=["utm_source","utm_campaign","utm_medium","utm_adgroup","utm_keyword","utm_term","gclid","msclkid","li_fat_id","fbclid","fbc_id"]};UrlDataCollector.prototype.get=function(){var obj={};const url=new URL(window.location.href);return this.attributes.forEach(attr=>{var key=attr,attrVal=url.searchParams.get(key);attrVal&&this.mappingKey[key]&&(key=this.mappingKey[key]),obj[key]=attrVal}),obj.channel=getChannel(),obj.landing_url=(url.hostname+url.pathname).substring(0,220),document.referrer&&document.referrer.search(window.location.host)<0&&(obj.utm_referrer=document.referrer.substring(0,220)),debugEnabled&&(console.log("---"),console.log("Data : "),console.log(obj),console.log("---")),obj};var HeeetLocalStorage=function(){this.name="heeet",this.isAvailable=isLocalStorageAvailable()};HeeetLocalStorage.prototype.isDatabaseExist=function(){return this.isAvailable&&localStorage.getItem(this.name)},HeeetLocalStorage.prototype.getFormattedDatetime=function(){return(new Date).toISOString()},HeeetLocalStorage.prototype.init=function(firstVisitData,lastVisitData){if(this.isAvailable){var channelIncrem=computeIncremental(lastVisitData.channel),interactionDetails=computeInteractionDetails([],firstVisitData,channelIncrem),customId;firstVisitData.datetime=this.getFormattedDatetime(),lastVisitData.datetime=this.getFormattedDatetime();try{customId=crypto.randomUUID()}catch(e){console.log(e)}localStorage.setItem(this.name,JSON.stringify({channel_incremental:{SEO:channelIncrem.SEO,SEA:channelIncrem.SEA,Direct:channelIncrem.Direct,Other:channelIncrem.Other},incremental_details:interactionDetails,first_visit:firstVisitData,last_visit:lastVisitData,createdAt:new Date,updatedAt:new Date,customId:customId}))}},HeeetLocalStorage.prototype.saveAll=function(data){localStorage.setItem(this.name,data)},HeeetLocalStorage.prototype.set=function(name,value){if(this.isAvailable){var heeet=JSON.parse(localStorage.getItem(this.name));heeet[name]=value,heeet.updatedAt=new Date,localStorage.setItem(this.name,JSON.stringify(heeet))}},HeeetLocalStorage.prototype.get=function(name){if(this.isAvailable){var heeet=JSON.parse(localStorage.getItem(this.name));return name?heeet[name]:heeet}};var UserJourney=function(heeetLocalStorage,formLookup){this.heeetLocalStorage=heeetLocalStorage,this.formLookup=formLookup};UserJourney.prototype.saveInStorage=function(visitData,sessionDuration){if(this.heeetLocalStorage.isDatabaseExist()){if(debugEnabled&&(console.log("---"),console.log("Session duration"),console.log(sessionDuration),console.log("---")),null==this.heeetLocalStorage.get("updatedAt")||dateDiffInMinutes(new Date(this.heeetLocalStorage.get("updatedAt")),new Date)>=sessionDuration){this.heeetLocalStorage.set("updatedAt",new Date);var incre=this.heeetLocalStorage.get("channel_incremental");if(incre)if("SEA"==visitData.channel){var seaChannel=getSEAChannel();incre[visitData.channel][seaChannel]?incre[visitData.channel][seaChannel]++:incre=computeIncremental(visitData.channel)}else incre[visitData.channel]++;else incre=computeIncremental(visitData.channel);var details=this.heeetLocalStorage.get("incremental_details"),interactionDetails=computeInteractionDetails(details,visitData,incre);this.heeetLocalStorage.set("incremental_details",interactionDetails),visitData.datetime=this.heeetLocalStorage.getFormattedDatetime(),this.heeetLocalStorage.set("last_visit",visitData),this.heeetLocalStorage.set("channel_incremental",incre),debugEnabled&&(console.log("---"),console.log("storage Updated"),console.log("---"))}}else this.heeetLocalStorage.init(visitData,visitData)},UserJourney.prototype.addCidToForm=function(parameters,cid){if(parameters.first&&(parameters.first.cidInputName||parameters.first.cidInputClass)){var classOrName=parameters.first.cidInputName?"name":"class";this.formLookup.setField({classOrName:classOrName,value:"name"===classOrName?parameters.first.cidInputName:parameters.first.cidInputClass},cid)}if(parameters.last&&(parameters.last.cidInputName||parameters.last.cidInputClass)){var classOrName=parameters.last.cidInputName?"name":"class";this.formLookup.setField({classOrName:classOrName,value:"name"===classOrName?parameters.last.cidInputName:parameters.last.cidInputClass},cid)}if(parameters.data){var content=this.heeetLocalStorage.get();content.cid=cid,this.formLookup.setField({classOrName:"."===parameters.data[0]?"class":"name",value:parameters.data},JSON.stringify(content))}},UserJourney.prototype.saveToForm=function(parameters){const _this=this;_this.formLookup.forms.forEach((function(form){if(_this.formLookup.form=form,parameters.data)_this.formLookup.setField({classOrName:"."===parameters.data[0]?"class":"name",value:parameters.data},JSON.stringify(_this.heeetLocalStorage.get()));else{const firstClickFields={},lastClickFields={};for(const[key,field]of Object.entries(HEEEET_KEYS)){if(parameters.first[key+"Name"]||parameters.first[key+"Class"]){var classOrName=parameters.first[key+"Name"]?"name":"class";firstClickFields[key]={classOrName:classOrName,field:field,value:"name"===classOrName?parameters.first[key+"Name"]:parameters.first[key+"Class"]}}if(parameters.last[key+"Name"]||parameters.last[key+"Class"]){var classOrName=parameters.last[key+"Name"]?"name":"class";lastClickFields[key]={classOrName:classOrName,field:field,value:"name"===classOrName?parameters.last[key+"Name"]:parameters.last[key+"Class"]}}}for(const object in firstClickFields){var fcData=firstClickFields[object];_this.formLookup.setField({classOrName:fcData.classOrName,value:fcData.value},_this.heeetLocalStorage.get("first_visit")[fcData.field])}for(const object in lastClickFields){var lcData=lastClickFields[object];_this.formLookup.setField({classOrName:lcData.classOrName,value:lcData.value},_this.heeetLocalStorage.get("last_visit")[lcData.field])}if(parameters.timezoneInputName||parameters.timezoneInputClass){var classOrName=parameters.timezoneInputName?"name":"class";_this.formLookup.setField({classOrName:classOrName,value:"name"===classOrName?parameters.timezoneInputName:parameters.timezoneInputClass},_this.heeetLocalStorage.get("timezone"))}if(parameters.incrementalDetailsInputName||parameters.incrementalDetailsInputClass){var classOrName=parameters.incrementalDetailsInputName?"name":"class";_this.formLookup.setField({classOrName:classOrName,value:"name"===classOrName?parameters.incrementalDetailsInputName:parameters.incrementalDetailsInputClass},JSON.stringify(_this.heeetLocalStorage.get("incremental_details")))}for(const key in HEEET_INCREMENTAL_KEYS)if(parameters[key+"Name"]||parameters[key+"Class"]){var classOrName=parameters[key+"Name"]?"name":"class",lsKey=HEEET_INCREMENTAL_KEYS[key].split(".");_this.heeetLocalStorage.get(lsKey[0])&&_this.formLookup.setField({classOrName:classOrName,value:"name"===classOrName?parameters[key+"Name"]:parameters[key+"Class"]},2==lsKey.length?_this.heeetLocalStorage.get(lsKey[0])[lsKey[1]]:_this.heeetLocalStorage.get(lsKey[0])[lsKey[1]][lsKey[2]])}}}))};const urlDataCollector=new UrlDataCollector,heeetLocalStorage=new HeeetLocalStorage;var saveJourney=function(parameters,formLookup){const sessionDuration=parameters&&parameters.sessionDuration?parameters.sessionDuration:24,userJourney=new UserJourney(heeetLocalStorage,formLookup),visitData=urlDataCollector.get();userJourney.saveInStorage(visitData,sessionDuration)},main;heeet=function(parameters){const formlookup=new FormLookup(parameters.formName,parameters.formCssSelector);parameters&&parameters.sessionDuration&&saveJourney(parameters,null);const userJourney=new UserJourney(heeetLocalStorage,formlookup);userJourney.saveToForm(parameters),parameters.sendToDashboard&&parameters.publishableKey&&sendDataToDashboard(parameters,formlookup,heeetLocalStorage,null);var interval=1e3;window.setTimeout((function(){if(parameters.ga4MeasurementId){const gaExtractor=new GaExtractor(gtag,parameters.ga4MeasurementId);gaExtractor.ga&&formlookup.forms.forEach((async function(form){formlookup.form=form;const cid=await gaExtractor.getCid();userJourney.addCidToForm(parameters,cid)}))}else window.setTimeout(arguments.callee,1e3)}),1e3)},heeetSaveJourney=saveJourney,window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:"user-journey-loaded"})}(window);
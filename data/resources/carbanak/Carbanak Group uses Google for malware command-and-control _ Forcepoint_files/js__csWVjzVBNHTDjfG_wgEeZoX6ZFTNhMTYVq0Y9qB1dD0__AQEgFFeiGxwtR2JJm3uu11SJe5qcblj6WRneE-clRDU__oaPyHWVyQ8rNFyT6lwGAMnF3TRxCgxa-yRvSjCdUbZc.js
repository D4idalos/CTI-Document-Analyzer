/**
 * Create cookies to persist area of interest and UTMs
 */
(function ($) {
  // Area of interest cookie
  const pageTopics = $('.field-page-topics').text().trim().split(',');
  const validAois = [
    'Data-first SASE',
    'SASE',
    'SD-WAN',
    'NGFW',
    'SSE',
    'Web Security',
    'Cloud Security',
    'Private App Security',
    'Threat Protection',
    'SWG',
    'CASB',
    'ZTNA',
    'RBI',
    'CDR',
    'Data Security',
    'DLP',
    'Risk Adaptive',
    'Classification',
    'Visibility',
    'Email Security',
    'Critical Infrastructure',
    'Cross Domain',
    'Insider Risk',
  ];
  let selectedAoi;
  pageTopics.forEach((pageAoi) => {
    if (selectedAoi === undefined) selectedAoi = validAois.find((validAoi) => validAoi === pageAoi);
  });

  function canStoreCookies() {
    const consentCookie = document.cookie.includes('CONSENTMGR')
      ? `; ${document.cookie}`.split('; CONSENTMGR=').pop().split(';').shift()
      : null;
    return consentCookie.includes('c4:1') || !consentCookie.includes('c4:');
  }

  function hashAoi(string) {
    string = encodeURIComponent(string);
    let newString = '',
      char, nextChar, combinedCharCode;
    for (let i = 0; i < string.length; i += 2) {
      char = string.charCodeAt(i);
      if ((i + 1) < string.length) {
        nextChar = string.charCodeAt(i + 1) - 31;
        combinedCharCode = char + "" + nextChar.toLocaleString('en', {
          minimumIntegerDigits: 2
        });
        newString += String.fromCharCode(parseInt(combinedCharCode, 10));
      } else {
        newString += string.charAt(i);
      }
    }
    return newString.split("")
      .reduce((hex, currentString) => {
        return hex += currentString.charCodeAt(0).toString(16).padStart(4, "0")}, "")
  }

  // Get UTM value from domain
  const queryParams = new URLSearchParams(document.location.search);
  // Check if last char is @ and remove it
  const utmValueFromUrl = queryParams.get('sf_src_cmpid');

  // Store cookie
  let hasConsentCookie = false;
  const checkConsentCookie = function() {
    return function() {
      if (!hasConsentCookie) {
        hasConsentCookie = document.cookie.includes('CONSENTMGR');
      } else if (canStoreCookies()) {
        // Create Area of interest cookie
        if (selectedAoi) {
          document.cookie = `aoi=${hashAoi(selectedAoi)}; path=/`;
        }
        // Create UTM cookie
        if (utmValueFromUrl) {
          const utmValue = utmValueFromUrl[utmValueFromUrl?.length - 1] === '@'
            ? utmValueFromUrl.slice(0, -1)
            : utmValueFromUrl;
          document.cookie = `sf_src_cmpid=${utmValue}; path=/`
        }
      }
    }
  }();

  window.setInterval(checkConsentCookie, 100);
})(jQuery);

;/*})'"*/
;/*})'"*/
